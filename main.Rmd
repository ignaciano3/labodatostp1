---
title: "Trabajo Práctico 1"
author: "Ignacio Garcia Pizales, ..."
date: "18 de Octubre"
output: html_notebook
---
------------------------------------------------------------------------

### Imports de paquetes

```{r eval=FALSE}
require(dplyr)
require(rvest)
require(xml2)
require(geosphere)
require(lubridate)
require(leaflet)
require(tibble)
require(ggplot2)
require(RColorBrewer)
require(readr)
require(polyline)
```

### Preprocesamiento

#### Archivos csv Vuelos
```{r}
viajes = read_csv2("202109-informe-ministerio.csv")

viajes <- viajes %>% 
              rename(Hora = `Hora UTC`,
                     Clase = `Clase de Vuelo (todos los vuelos)`,
                     Clasificación = `Clasificación Vuelo`,
                     Tipo = `Tipo de Movimiento`,
                     Destino = `Origen / Destino`,
                     Aerolinea = `Aerolinea Nombre`,
                     Calidad = `Calidad dato`)
viajes$Fecha_Hora = paste(viajes$Fecha, viajes$Hora)
typeof(viajes$Fecha_Hora)
viajes$Fecha_Hora = dmy_hms(viajes$Fecha_Hora)
viajes <- subset(viajes, select = -c(Fecha, Hora, Calidad))
viajes = add_column(viajes, id = 1:nrow(viajes), .before = 1)
head(sample_n(viajes, 10))
```


##### Separo en aterrizajes y despegues

```{r}
aterrizajes <- viajes %>% filter(Tipo == "Aterrizaje" & Clase == "Regular" & Clasificación == "Dom")
despegues <- viajes %>% filter(Tipo == "Despegue" & Clase == "Regular" & Clasificación == "Dom")
aterrizajes <- subset(aterrizajes, select = -c(Clase, Clasificación, Tipo))
despegues <- subset(despegues, select = -c(Clase, Clasificación, Tipo))

viajes_organizado <- despegues %>% 
                      inner_join(aterrizajes, by =
                               c("Destino" = "Aeropuerto",
                                 "Aeropuerto" = "Destino",
                                 "Aeronave" = "Aeronave",
                                 "Aerolinea" = "Aerolinea",
                                 "Pasajeros" = "Pasajeros"),
                               suffix = c("_despegue", "_aterrizaje"))

viajes_organizado$dif_horaria = difftime(viajes_organizado$Fecha_Hora_aterrizaje, viajes_organizado$Fecha_Hora_despegue, units = "hours")
viajes_organizado$dif_horaria = as.numeric(viajes_organizado$dif_horaria)
viajes_organizado <- viajes_organizado %>% filter(dif_horaria <= 10 & dif_horaria >= 0)
viajes_organizado = viajes_organizado %>% distinct(id_despegue, .keep_all = TRUE)
viajes_organizado = viajes_organizado %>% distinct(id_aterrizaje, .keep_all = TRUE)

rm(viajes, aterrizajes, despegues)
head(viajes_organizado, 100)
```

```{r}
viajes_organizado$dia_semana_despegue = wday(viajes_organizado$Fecha_Hora_despegue, label = TRUE, abbr = FALSE)
viajes_organizado$dia_semana_aterrizaje = wday(viajes_organizado$Fecha_Hora_aterrizaje, label = TRUE, abbr = FALSE)
head(sample_n(viajes_organizado, 100),100)
```

### Gráficos

```{r}
n_occur <- viajes_organizado %>%
            group_by(dia_semana_despegue) %>%
            summarise(n = n())
coul <- brewer.pal(7, "Set2") 
promedio = mean(n_occur$n)
ggplot(data=n_occur, aes(x=dia_semana_despegue, y=n)) +
  ggtitle("Dias despegue") +
  geom_bar(stat="identity", width = 0.7, fill = coul) +
  geom_hline(yintercept = promedio, lwd = 1.3, col ="red") +
  xlab(element_blank()) +
  ylab("número de Vuelos") +
  theme_light()
rm(coul)
```

```{r}
n_occur <- viajes_organizado %>%
            group_by(Aeropuerto, Destino) %>%
            summarise(n = n())

for (i in 1:nrow(n_occur)){
  origen = n_occur$Aeropuerto[i]
  destino = n_occur$Destino[i]
}

m <- leaflet()%>%
  addTiles() %>%
  addCircleMarkers(data = n_occur_aeropuerto, lat = ~lat, lng = ~lon, radius = ~n/max(n)*10)
m
```


### Parte Wikipedia

```{r}
aeropuertos = read_csv("sna_abril_2021_fixed_encoding (1).csv")
aeropuertos <- subset(aeropuertos, select = c(fna, nam, ana, x, y))
aeropuertos = aeropuertos %>% rename(Nombre = fna,
                                     Ciudad = nam,
                                     id = ana,
                                     lon = x,
                                     lat = y)
head(aeropuertos)
```

```{r}
n_occur_aeropuerto <- viajes_organizado %>%
            group_by(Aeropuerto) %>%
            summarise(n = n())
n_occur_aeropuerto = n_occur_aeropuerto %>% left_join(aeropuertos, by = c("Aeropuerto" = "id"))

```


1. El dataset tiene el código de los aeropuertos. Agreguen nuevas variables con la ciudad,
provincia y coordenadas que corresponde a cada aeropuerto. Pueden encontrar esta
información en este artículo de Wikipedia

2. Calculen la distancia recorrida por cada vuelo. La función distHaversine del paquete
geosphere puede resultarles útil.

3. Calculen la velocidad media de cada vuelo 

```{r}
# pag_wiki = read_html("https://en.wikipedia.org/wiki/List_of_airports_in_Argentina")
# elem_tabla = html_element(pag_wiki, ".wikitable")
# 
# latitud = html_nodes(pag_wiki, css = '.latitude')
# latitud = html_text(latitud)
# 
# longitud = html_nodes(pag_wiki, css = '.longitude')
# longitud = html_text(longitud)
# 
# aeropuertos = html_table(elem_tabla)
# aeropuertos <- subset(aeropuertos, select = -c(ICAO, Coordinates))# Elimino ICAO, Coordenadas
# aeropuertos["latitud"] = latitud
# aeropuertos["longitud"] = longitud
# 
# aeropuertos <- aeropuertos %>% filter(IATA != "")
# 
# rm(list = c("pag_wiki", "elem_tabla", "latitud", "longitud")) #Esto es para que no queden variables sueltas
# head(aeropuertos, 10)
```

